name: Deploy Web App

on:
  push:
    branches: ["master"]
    paths:
      - "src/AlbumViewerAngular/**"
      - ".github/workflows/deploy-web.yml"
  workflow_dispatch:

env:
  WEB_APP_NAME: sk-albumviewer-web
  AZURE_RESOURCE_GROUP: sk-albumviewer-rg
  WEB_PROJECT_PATH: src/AlbumViewerAngular

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "16"

      - name: Install & Build
        run: |
          set -e
          cd ${{ env.WEB_PROJECT_PATH }}
          npm ci --silent || npm install --no-audit --no-fund
          npm run build -- --configuration=production
          if [ -f src/web.config ]; then cp src/web.config dist/; fi

      - name: Azure login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Generate env.js from App Settings (printf)
        run: |
          set -e
          SETTINGS=$(az webapp config appsettings list --resource-group "${{ env.AZURE_RESOURCE_GROUP }}" --name "${{ env.WEB_APP_NAME }}" --query "[].{n:name,v:value}" --output tsv || true)
          API_URL=""
          APPINSIGHTS=""
          ENVIRONMENT="production"
          while IFS=$'\t' read -r name value; do
            case "$name" in
              API_URL) API_URL="$value" ;;
              APPLICATIONINSIGHTS_CONNECTION_STRING) APPINSIGHTS="$value" ;;
              ASPNETCORE_ENVIRONMENT) ENVIRONMENT="$value" ;;
            esac
          done <<< "$SETTINGS"
          API_URL=${API_URL:-"https://api-placeholder.azurewebsites.net"}
          mkdir -p ${{ env.WEB_PROJECT_PATH }}/dist
          printf "(function (window) {\n  window.__env = window.__env || {};\n  window.__env.API_URL = '%s';\n  window.__env.APPLICATIONINSIGHTS_CONNECTION_STRING = '%s';\n  window.__env.ENVIRONMENT = '%s';\n})(this);\n" "$API_URL" "$APPINSIGHTS" "$ENVIRONMENT" > ${{ env.WEB_PROJECT_PATH }}/dist/env.js
          echo "--- env.js ---"
          sed -n '1,200p' ${{ env.WEB_PROJECT_PATH }}/dist/env.js || true

      - name: Zip and deploy
        run: |
          set -e
          cd ${{ env.WEB_PROJECT_PATH }}/dist
          zip -r ../deployment.zip .
          az webapp deployment source config-zip --resource-group "${{ env.AZURE_RESOURCE_GROUP }}" --name "${{ env.WEB_APP_NAME }}" --src ../deployment.zip

      - name: Smoke check
        run: |
          set -e
          WEB_URL="https://${{ env.WEB_APP_NAME }}.azurewebsites.net"
          curl -f "$WEB_URL" || (echo "Root page check failed" && exit 1)
